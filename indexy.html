<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üåç Disaster Alert & Resource Mapper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0f172a">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

  <style>
    :root {
      /* Common colors */
      --primary: #3b82f6;
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #10b981;
      --accent: #8b5cf6;
      --info: #06b6d4;
      
      /* Dark theme (default) */
      --background: #0f172a;
      --background-lighter: #1e293b;
      --text: #f8fafc;
      --map-bg: rgba(255, 255, 255, 0.1);
      --map-border: rgba(255, 255, 255, 0.1);
      --leaflet-bg: rgba(255, 255, 255, 0.05);
    }
    
    /* Light theme class */
    .light-theme {
      --background: #f8fafc;
      --background-lighter: #e2e8f0;
      --text: #0f172a;
      --map-bg: rgba(0, 0, 0, 0.05);
      --map-border: rgba(0, 0, 0, 0.1);
      --leaflet-bg: rgba(0, 0, 0, 0.02);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      transition: all 0.3s ease;
    }
    
    body { 
      margin: 0; 
      font-family: 'Poppins', sans-serif; 
      background: var(--background); 
      color: var(--text);
      line-height: 1.6;
    }
    
    header { 
      background: linear-gradient(135deg, var(--danger), var(--accent)); 
      padding: 1.2rem; 
      text-align: center; 
      font-size: 1.8rem; 
      font-weight: 700;
      font-family: 'Montserrat', sans-serif;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }
    
    .header-content {
      position: relative;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .theme-toggle {
      display: none !important;
    }
    
    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    
    #theme-toggle-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Poppins', sans-serif;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    #theme-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
      animation: ripple 15s infinite linear;
      z-index: 1;
      pointer-events: none;
    }
    
    header span {
      position: relative;
      z-index: 2;
    }
    
    @keyframes ripple {
      0% { transform: translate(0, 0) rotate(0deg); }
      100% { transform: translate(0, 0) rotate(360deg); }
    }
    
    #map { 
      height: 60vh; 
      width: 100%;
      border-radius: 12px; 
      box-shadow: 0 10px 15px rgba(0,0,0,0.2);
      border: 2px solid var(--map-border);
      z-index: 10;
      position: relative;
    }
    
    .sos-btn { 
      display: block; 
      margin: 0; 
      padding: 1rem 2.5rem; 
      background: linear-gradient(to right, var(--danger), #ff6b6b); 
      color: white; 
      border: none; 
      border-radius: 50px; 
      font-size: 1.3rem; 
      font-weight: 600;
      cursor: pointer; 
      box-shadow: 0 4px 10px rgba(239, 68, 68, 0.5), 0 0 0 2px rgba(255,255,255,0.3);
      transform: translateY(0);
      letter-spacing: 1px;
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      z-index: 2000;
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    .sos-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(239, 68, 68, 0.6);
    }
    
    .sos-btn:active {
      transform: translateY(1px);
    }
    
    .alerts { 
      background: var(--background-lighter); 
      padding: 0.8rem; 
      overflow: hidden; 
      white-space: nowrap;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
      position: relative;
      font-size: 0.9rem;
    }
    
    .alert { 
      display: inline-block; 
      margin-right: 1.2rem; 
      padding: 0.5rem 1rem; 
      background: var(--danger); 
      border-radius: 8px; 
      animation: pulse 2s infinite, slide 15s linear infinite;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      font-weight: 500;
      color: var(--text);
    }
    
    @keyframes pulse { 
      0%, 100% { opacity: 1; transform: scale(1); } 
      50% { opacity: 0.8; transform: scale(0.98); }
    }
    
    @keyframes slide {
      0% { transform: translateX(100vw); }
      100% { transform: translateX(-100vw); }
    }
    
    .guidelines { 
      margin: 1.2rem; 
      padding: 1.5rem; 
      background: var(--background-lighter); 
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border-left: 4px solid var(--primary);
    }
    
    .guidelines h2 { 
      margin-top: 0; 
      color: var(--primary);
      font-family: 'Montserrat', sans-serif;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.4rem;
    }
    
    .guidelines ul {
      margin-left: 1.5rem;
      margin-top: 0.8rem;
    }
    
    .guidelines li {
      margin-bottom: 0.5rem;
    }
    
    /* Map Container Styles */
    .map-container {
      position: relative;
      margin: 1.2rem;
      height: auto;
      width: auto;
      z-index: 1;
      background-color: var(--map-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      border: 2px solid var(--map-border);
      padding: 0;
    }
    
    /* Fix for Leaflet map visibility */
    .leaflet-container {
      height: 100%;
      width: 100%;
      z-index: 1;
      background: var(--leaflet-bg) !important;
    }
    
    /* Make map tiles more transparent */
    .leaflet-tile-pane {
      opacity: 0.7;
    }
    
    /* Improve map controls visibility */
    .leaflet-control-zoom {
      background: rgba(255, 255, 255, 0.8) !important;
      border: none !important;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3) !important;
    }
    
    /* Improve map attribution visibility */
    .leaflet-control-attribution {
      background: rgba(255, 255, 255, 0.8) !important;
      color: #333 !important;
    }
    
    /* Enhance map markers visibility */
    .map-custom-icon i {
      filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.7));
      font-size: 28px !important;
    }
    
    /* Improve touch targets for mobile */
    .leaflet-control-zoom a {
      width: 36px !important;
      height: 36px !important;
      line-height: 36px !important;
      font-size: 18px !important;
    }
    
    /* Prevent text selection on mobile */
    .legend-item, .stat-title, .stat-desc, button, .guidelines h2, .guidelines li {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    /* Ensure icons are visible in both themes */
    .light-theme .map-custom-icon i {
      filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.5));
    }
    
    .dark-theme .map-custom-icon i {
      filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.3));
    }
    
    .map-overlay {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(15, 23, 42, 0.8);
      padding: 10px;
      border-radius: 8px;
      z-index: 1000;
      backdrop-filter: blur(5px);
      border: 1px solid var(--map-border);
      max-width: 80%;
    }
    
    .map-legend {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    
    /* Stats Section */
    .stats-container {
      margin: 1.2rem;
      padding: 1.5rem;
      background: var(--background-lighter);
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stats-container h2 {
      color: var(--primary);
      font-family: 'Montserrat', sans-serif;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.4rem;
      margin-bottom: 1rem;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
    }
    
    .stat-card {
      background: var(--background);
      border-radius: 10px;
      padding: 1.2rem;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px rgba(0,0,0,0.2);
    }
    
    .stat-icon {
      font-size: 2rem;
      margin-bottom: 0.8rem;
      color: var(--primary);
    }
    
    .stat-card:nth-child(1) .stat-icon { color: var(--info); }
    .stat-card:nth-child(2) .stat-icon { color: var(--accent); }
    .stat-card:nth-child(3) .stat-icon { color: var(--warning); }
    .stat-card:nth-child(4) .stat-icon { color: var(--danger); }
    
    .stat-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-family: 'Montserrat', sans-serif;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.3rem;
    }
    
    .stat-desc {
      font-size: 0.9rem;
      opacity: 0.7;
    }
    
    /* Footer */
    footer {
      background: var(--background-lighter);
      text-align: center;
      padding: 1rem;
      margin-top: 2rem;
      font-size: 0.9rem;
      border-top: 1px solid var(--map-border);
    }
    
    footer .fa-heart {
      color: var(--danger);
    }
    
    /* Utility Classes */
    .text-primary { color: var(--primary); }
    .text-danger { color: var(--danger); }
    .text-warning { color: var(--warning); }
    .text-success { color: var(--success); }
    .text-info { color: var(--info); }
    .text-accent { color: var(--accent); }
    
    /* Mobile Touch Improvements */
    button, .legend-item, .stat-card {
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Ensure SOS button is always visible */
    .sos-btn {
      -webkit-tap-highlight-color: transparent;
      will-change: transform;
      transform: translateZ(0);
      backface-visibility: hidden;
      perspective: 1000px;
    }
    
    /* Add active state for touch devices */
    @media (hover: none) {
      button:active, .sos-btn:active, .stat-card:active {
        transform: scale(0.97);
        transition: transform 0.1s;
      }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .header-content {
        flex-direction: column;
        gap: 0.5rem;
        align-items: center;
      }
      
      header h1 {
        font-size: 1.6rem;
        text-align: center;
      }
      
      .map-container {
        margin: 0.5rem;
        border-radius: 10px;
      }
      
      .map-legend {
        flex-direction: column;
        padding: 0.5rem;
      }
      
      .legend-item {
        margin-right: 0;
        margin-bottom: 0.3rem;
      }
      
      .guidelines, .stats-container {
        margin: 0.5rem;
        padding: 1rem;
      }
    }
    
    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      header {
        padding: 0.8rem;
      }
      
      header h1 {
        font-size: 1.3rem;
      }
      
      .theme-toggle button {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }
      
      .sos-btn {
        font-size: 1rem;
        padding: 0.7rem 1.5rem;
        bottom: 1rem;
        right: 1rem;
      }
      
      .alert {
        padding: 0.5rem;
        font-size: 0.8rem;
        margin-bottom: 0.3rem;
      }
      
      #map {
        height: 50vh !important;
      }
      
      .stat-card {
        padding: 0.8rem;
      }
      
      .stat-value {
        font-size: 1.5rem;
      }
      
      .stat-icon {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1><i class="fas fa-globe-americas"></i> Disaster Alert & Resource Mapper</h1>
      <div class="theme-toggle">
        <button id="theme-toggle-btn" aria-label="Toggle theme">
          <i class="fas fa-sun"></i>
          <span>Light Mode</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Alerts -->
  <div class="alerts" id="alerts"></div>

  <!-- Map Container -->
  <div class="map-container">
    <div id="map"></div>
    <div class="map-overlay" id="map-overlay">
      <div class="map-legend">
        <div class="legend-item"><i class="fas fa-campground text-success"></i> Shelter Camp</div>
        <div class="legend-item"><i class="fas fa-check-circle text-success"></i> Safe Zone</div>
        <div class="legend-item"><i class="fas fa-exclamation-triangle text-danger"></i> Danger Zone</div>
      </div>
    </div>
  </div>

  <!-- SOS Button -->
  <button class="sos-btn" onclick="sendSOS()"><i class="fas fa-exclamation-circle"></i> Send SOS</button>

  <!-- Guidelines -->
  <div class="guidelines" id="guidelines">
    <h2><i class="fas fa-book"></i> Safety Guidelines</h2>
    <p>Click a red zone on the map to see safety instructions.</p>
  </div>
  
  <!-- Stats Section -->
  <div class="stats-container">
    <h2><i class="fas fa-chart-bar"></i> Disaster Statistics</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-water"></i></div>
        <div class="stat-title">Floods</div>
        <div class="stat-value">3</div>
        <div class="stat-desc">Active alerts</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-wind"></i></div>
        <div class="stat-title">Cyclones</div>
        <div class="stat-value">1</div>
        <div class="stat-desc">Active alerts</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-mountain"></i></div>
        <div class="stat-title">Landslides</div>
        <div class="stat-value">2</div>
        <div class="stat-desc">Active alerts</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-fire"></i></div>
        <div class="stat-title">Fires</div>
        <div class="stat-value">4</div>
        <div class="stat-desc">Active alerts</div>
      </div>
    </div>
  </div>
  
  <!-- Footer -->
  <footer>
    <p>&copy; 2023 Disaster Management System | <i class="fas fa-code"></i> with <i class="fas fa-heart"></i></p>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Animation Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
  
  <script>
    // Initialize variables for map and theme elements
    const body = document.body;
    const themeBtn = document.getElementById('theme-toggle-btn');
    let map, darkTileLayer, lightTileLayer;
    let currentTheme = localStorage.getItem('theme') || 'dark';
    
    // Initialize marker arrays
    let shelterMarkers = [];
    let safeMarkers = [];
    let redMarkers = [];
    
    // Apply initial theme class
    if (currentTheme === 'light') {
      body.classList.add('light-theme');
      themeBtn.innerHTML = '<i class="fas fa-moon"></i><span>Dark Mode</span>';
    } else {
      body.classList.add('dark-theme');
    }
    
    // Initialize map and components
     function initializeMap() {
       try {
         // Initialize icons first
         initializeIcons();
         
         // Map setup (centered Delhi) with mobile-friendly options
         map = L.map('map', {
           zoomControl: false,
           attributionControl: false,
           tap: true,
           dragging: true,
           touchZoom: true,
           scrollWheelZoom: true,
           doubleClickZoom: true,
           boxZoom: false,
           keyboard: false
         }).setView([28.61, 77.23], 12);
         
         // Define tile layers for different themes
         darkTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
           attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
           maxZoom: 19,
           opacity: 0.9
         });
         
         lightTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
           attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
           maxZoom: 19,
           opacity: 1.0
         });
         
         // Add the appropriate tile layer based on theme
         if (currentTheme === 'light') {
           lightTileLayer.addTo(map);
         } else {
           darkTileLayer.addTo(map);
         }
         
         // Add a custom pane for markers to ensure they're visible
         map.createPane('markers');
         map.getPane('markers').style.zIndex = 650;
         map.getPane('markers').style.pointerEvents = 'none';
         
         // Add zoom control to top-right
         L.control.zoom({
           position: 'topright'
         }).addTo(map);
         
         // Force immediate map invalidation and redraw
         map.invalidateSize();
         
         // Setup theme toggle functionality after map is initialized
          setupThemeToggle();
          
          // Load map data after initialization
          loadSimulatedData();
          setInterval(loadSimulatedData, 20000); // refresh every 20s
          
          console.log('Map initialized successfully');
       } catch (error) {
         console.error('Error initializing map:', error);
       }
     }
    
    // Setup theme toggle functionality
    function setupThemeToggle() {
      themeBtn.addEventListener('click', function() {
        if (body.classList.contains('light-theme')) {
          // Switch to dark theme
          body.classList.remove('light-theme');
          body.classList.add('dark-theme');
          themeBtn.innerHTML = '<i class="fas fa-sun"></i><span>Light Mode</span>';
          localStorage.setItem('theme', 'dark');
          
          // Switch map tile layer
          map.removeLayer(lightTileLayer);
          darkTileLayer.addTo(map);
        } else {
          // Switch to light theme
          body.classList.add('light-theme');
          body.classList.remove('dark-theme');
          themeBtn.innerHTML = '<i class="fas fa-moon"></i><span>Dark Mode</span>';
          localStorage.setItem('theme', 'light');
          
          // Switch map tile layer
          map.removeLayer(darkTileLayer);
          lightTileLayer.addTo(map);
        }
        
        // Force immediate map redraw to apply theme changes
        map.invalidateSize();
      });
    }
    
    // Page load without map animations
    window.addEventListener('load', function() {
      // Initialize map first
      initializeMap();
      
      // Animate header
      gsap.from('header', {duration: 0.8, y: -30, opacity: 0, ease: 'power3.out'});
      
      // Make SOS button immediately visible
      document.querySelector('.sos-btn').style.opacity = '1';
      
      // Animate guidelines
      document.querySelectorAll('.guidelines li').forEach(li => { li.style.opacity = '1'; li.style.transform = 'none'; });
      
      // Animate stats cards
      gsap.from('.stat-card', {
        duration: 0.8, 
        y: 30, 
        opacity: 0, 
        stagger: 0.1, 
        delay: 0.4, 
        ease: 'power2.out'
      });
      
      // Animate footer
      gsap.from('footer', {duration: 0.8, y: 20, opacity: 0, delay: 1.5, ease: 'power2.out'});
      
      // Force map redraw immediately
      map.invalidateSize();
      
      // Ensure SOS button is always visible
      document.querySelector('.sos-btn').style.zIndex = '2000';
    });
    
    // Custom map icons
    let shelterIcon, safeIcon, dangerIcon;
    
    function initializeIcons() {
      shelterIcon = L.divIcon({
        html: '<i class="fas fa-campground" style="color: #10b981; font-size: 24px;"></i>',
        className: 'map-custom-icon',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      });
      
      safeIcon = L.divIcon({
        html: '<i class="fas fa-check-circle" style="color: #10b981; font-size: 24px;"></i>',
        className: 'map-custom-icon',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      });
      
      dangerIcon = L.divIcon({
        html: '<i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 24px;"></i>',
        className: 'map-custom-icon',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      });
    }

    // Disaster alerts simulation with enhanced data
    const alertsList = [
      { type: "Flood", msg: "‚ö†Ô∏è Flood alert: River Yamuna rising!", icon: "fa-water", color: "#06b6d4" },
      { type: "Cyclone", msg: "üå™Ô∏è Cyclone warning in Bay of Bengal.", icon: "fa-wind", color: "#8b5cf6" },
      { type: "Earthquake", msg: "üåç Earthquake tremors felt in NCR.", icon: "fa-house-crack", color: "#f59e0b" },
      { type: "Fire", msg: "üî• Major fire near industrial area.", icon: "fa-fire", color: "#ef4444" },
      { type: "Landslide", msg: "‚õ∞Ô∏è Landslide risk in hilly regions.", icon: "fa-mountain", color: "#84cc16" }
    ];

    function updateAlerts() {
      const alertsDiv = document.getElementById("alerts");
      alertsDiv.innerHTML = "";
      // Pick 3 random alerts
      const randomAlerts = alertsList.sort(() => 0.5 - Math.random()).slice(0, 3);
      randomAlerts.forEach(a => {
        const div = document.createElement("div");
        div.className = "alert";
        div.innerHTML = `<i class="fas ${a.icon}"></i> ${a.msg}`;
        div.style.background = a.color;
        alertsDiv.appendChild(div);
      });
    }
    updateAlerts();
    setInterval(updateAlerts, 8000); // update every 8s

    // Simulated resources

    function randomCoord(baseLat, baseLng) {
      return [baseLat + (Math.random()-0.5)*0.1, baseLng + (Math.random()-0.5)*0.1];
    }

    function loadSimulatedData() {
      // clear old
      [...shelterMarkers, ...safeMarkers, ...redMarkers].forEach(m => map.removeLayer(m));
      shelterMarkers=[]; safeMarkers=[]; redMarkers=[];

      // Shelters
      for (let i=0; i<3; i++) {
        const [lat, lng] = randomCoord(28.61, 77.23);
        const m = L.marker([lat, lng], {icon: shelterIcon, pane: 'markers'}).addTo(map)
          .bindPopup(`<div class="popup-content"><h3><i class="fas fa-campground"></i> Shelter Camp</h3><p>Capacity: ${Math.floor(Math.random() * 200) + 100} people</p><p>Status: Open</p><button class="popup-btn">Get Directions</button></div>`);
        shelterMarkers.push(m);
      }
      
      // Safe Zones
      for (let i=0; i<3; i++) {
        const [lat, lng] = randomCoord(28.61, 77.23);
        const m = L.marker([lat, lng], {icon: safeIcon, pane: 'markers'}).addTo(map)
          .bindPopup(`<div class="popup-content"><h3><i class="fas fa-check-circle"></i> Safe Zone</h3><p>Medical facilities: Available</p><p>Water supply: Available</p><button class="popup-btn">Get Directions</button></div>`);
        safeMarkers.push(m);
      }
      
      // Danger Zones
      for (let i=0; i<4; i++) {
        const [lat, lng] = randomCoord(28.61, 77.23);
        const typeIndex = Math.floor(Math.random() * alertsList.length);
        const alert = alertsList[typeIndex];
        const m = L.marker([lat, lng], {icon: dangerIcon, pane: 'markers'}).addTo(map)
          .bindPopup(`<div class="popup-content danger"><h3><i class="fas ${alert.icon}"></i> ${alert.type} Danger Zone</h3><p>Severity: High</p><p>Evacuation: Recommended</p><button class="popup-btn warning" onclick="showGuidelines('${alert.type}')">Safety Guidelines</button></div>`);
        m.on("click", () => showGuidelines(alert.type));
        redMarkers.push(m);
      }
      
      // Update stats
      updateStats();
    }
    
    // Data will be loaded after map initialization

    // Update statistics
    function updateStats() {
      document.querySelectorAll('.stat-value').forEach((el, index) => {
        const newValue = Math.floor(Math.random() * 5) + 1;
        
        // Animate the number change
        const oldValue = parseInt(el.textContent) || 0;
        let currentValue = oldValue;
        
        const updateCounter = () => {
          if (currentValue < newValue) {
            currentValue++;
            el.textContent = currentValue;
            setTimeout(updateCounter, 200);
          } else if (currentValue > newValue) {
            currentValue--;
            el.textContent = currentValue;
            setTimeout(updateCounter, 200);
          }
        };
        
        updateCounter();
      });
    }

    // Enhanced SOS with improved visibility
    function sendSOS() {
      const sosBtn = document.querySelector('.sos-btn');
      
      // Ensure button is visible
      sosBtn.style.opacity = '1';
      sosBtn.style.visibility = 'visible';
      sosBtn.style.zIndex = '2000';
      
      // Animate button
      sosBtn.classList.add('sending');
      sosBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending SOS...';
      
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          setTimeout(() => {
            sosBtn.innerHTML = '<i class="fas fa-check-circle"></i> SOS Sent!';
            
            // Create a custom marker at user's location
            const userLocation = [pos.coords.latitude, pos.coords.longitude];
            const sosMarker = L.marker(userLocation, {
              icon: L.divIcon({
                html: '<i class="fas fa-user-circle" style="color: #3b82f6; font-size: 24px;"></i>',
                className: 'map-custom-icon',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
              })
            }).addTo(map);
            
            // Create a pulsing circle
            const circle = L.circle(userLocation, {
              color: '#3b82f6',
              fillColor: '#3b82f6',
              fillOpacity: 0.3,
              radius: 0
            }).addTo(map);
            
            // Animate the circle
            const animateCircle = () => {
              let radius = 0;
              const maxRadius = 1000;
              const interval = setInterval(() => {
                radius += 50;
                circle.setRadius(radius);
                circle.setStyle({ fillOpacity: 0.5 - (radius / maxRadius / 2) });
                
                if (radius >= maxRadius) {
                  clearInterval(interval);
                  setTimeout(() => {
                    map.removeLayer(circle);
                  }, 1000);
                }
              }, 50);
            };
            
            animateCircle();
            
            // Center map on user location
            map.setView(userLocation, 14);
            
            // Reset button after 3 seconds
            setTimeout(() => {
              sosBtn.classList.remove('sending');
              sosBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Send SOS';
            }, 3000);
            
          }, 1500);
        }, error => {
          sosBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Location Error';
          setTimeout(() => {
            sosBtn.classList.remove('sending');
            sosBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Send SOS';
          }, 2000);
        });
      } else {
        sosBtn.innerHTML = '<i class="fas fa-times-circle"></i> Not Supported';
        setTimeout(() => {
          sosBtn.classList.remove('sending');
          sosBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Send SOS';
        }, 2000);
      }
    }

    // Enhanced Guidelines
    function showGuidelines(type) {
      const box = document.getElementById("guidelines");
      let html = "";
      
      // Instantly update content (removed fade-out to avoid invisibility)
      box.style.opacity = '1';
        // Update content
        if(type === "Flood") {
          html = `
            <h2><i class="fas fa-water"></i> Flood Safety</h2>
            <ul>
              <li><strong>Move to higher ground</strong> - Evacuate if advised.</li>
              <li><strong>Avoid floodwater</strong> - Just 6 inches of water can knock you down.</li>
              <li><strong>Prepare emergency kit</strong> - Include water, food, medications.</li>
              <li><strong>Turn off utilities</strong> - If instructed, turn off gas, water, and electricity.</li>
            </ul>
          `;
        } else if(type === "Cyclone") {
          html = `
            <h2><i class="fas fa-wind"></i> Cyclone Safety</h2>
            <ul>
              <li><strong>Stay indoors</strong> - Away from windows and exterior walls.</li>
              <li><strong>Communication ready</strong> - Keep mobile phones charged and radio handy.</li>
              <li><strong>Stock supplies</strong> - Have at least 3 days of food and water.</li>
              <li><strong>Secure loose items</strong> - Bring in outdoor furniture and secure other items.</li>
            </ul>
          `;
        } else if(type === "Earthquake") {
          html = `
            <h2><i class="fas fa-house-crack"></i> Earthquake Safety</h2>
            <ul>
              <li><strong>Drop, Cover, Hold On</strong> - Get under sturdy furniture.</li>
              <li><strong>Stay away from glass</strong> - Windows and mirrors can shatter.</li>
              <li><strong>Move outdoors when safe</strong> - To an open area away from buildings.</li>
              <li><strong>Check for injuries</strong> - Provide first aid if needed.</li>
            </ul>
          `;
        } else if(type === "Fire") {
          html = `
            <h2><i class="fas fa-fire"></i> Fire Safety</h2>
            <ul>
              <li><strong>Evacuate immediately</strong> - Don't waste time gathering possessions.</li>
              <li><strong>Stay low</strong> - Crawl under smoke if necessary.</li>
              <li><strong>Test doors before opening</strong> - Use the back of your hand to feel for heat.</li>
              <li><strong>Call emergency services</strong> - Once you're safely outside.</li>
            </ul>
          `;
        } else if(type === "Landslide") {
          html = `
            <h2><i class="fas fa-mountain"></i> Landslide Safety</h2>
            <ul>
              <li><strong>Move away from slope</strong> - Get to stable ground quickly.</li>
              <li><strong>Listen for unusual sounds</strong> - Like trees cracking or boulders knocking.</li>
              <li><strong>Watch for changes</strong> - In water flow or land movement.</li>
              <li><strong>Follow evacuation orders</strong> - Don't return until authorities say it's safe.</li>
            </ul>
          `;
        } else {
          html = `<h2><i class="fas fa-info-circle"></i> Safety</h2><p>Follow official instructions and stay tuned to emergency broadcasts.</p>`;
        }
        
        box.innerHTML = html;
        
        // Ensure visibility of new content
        box.style.opacity = '1';
        document.querySelectorAll('.guidelines li').forEach(li => { li.style.opacity = '1'; li.style.transform = 'none'; });
    }
    
    // Add custom CSS for popups
    const style = document.createElement('style');
    style.textContent = `
      .leaflet-popup-content-wrapper {
        background: var(--dark-lighter);
        color: var(--light);
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      }
      
      .leaflet-popup-tip {
        background: var(--dark-lighter);
      }
      
      .popup-content {
        padding: 5px;
      }
      
      .popup-content h3 {
        margin-top: 0;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: 'Montserrat', sans-serif;
        font-size: 1rem;
      }
      
      .popup-content p {
        margin: 5px 0;
        font-size: 0.9rem;
      }
      
      .popup-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        margin-top: 10px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.2s ease;
      }
      
      .popup-btn:hover {
        background: #2563eb;
      }
      
      .popup-btn.warning {
        background: var(--danger);
      }
      
      .popup-btn.warning:hover {
        background: #dc2626;
      }
      
      .map-custom-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
      }
      
      .sending {
        background: var(--dark-lighter) !important;
        color: var(--light) !important;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
